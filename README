How This Web App Works (Complete Explanation)

This documentation should allow any programmer to fully:
Understand system data flow
Understand personal vs technical branching
Understand how PDFs are built
Understand how Shopify front-end interacts with Node backend
Understand reCAPTCHA + Resend + OpenAI workflows
Maintain or extend the system correctly

1. High-Level Overview

Your application is a Shopify-embedded spiritual / technical answer generator.
It collects a user question, optionally collects personal data, verifies reCAPTCHA, calls your backend API (Vercel serverless functions), generates an AI-Powered summary + PDF report, emails it to the user via Resend, and displays a short answer on the webpage.

Depending on whether the question is personal or non-personal, two very different workflows are triggered.

2. Frontend (Liquid + JavaScript)

The Liquid template is responsible for:

âœ” Rendering the form (mobile-friendly)
âœ” Slide-down personal information fields if user checks â€œIs this a personal question?â€
âœ” Rendering reCAPTCHA v2 Checkbox with explicit mode
âœ” Collecting fields + palm image using FormData
âœ” Sending request to Vercel backend
âœ” Animated progress bar + spinner
âœ” Showing a short answer on-screen
âœ” Triggering â€œGet Detailed Report (Free)â€ button
âœ” (NEW) Allowing non-personal users to enter email only when requesting PDF
âœ” Displaying OpenAI censorship warnings if content blocked
3. reCAPTCHA Workflow
Frontend

/api/spiritual-report.js â€” The Main Processor

This endpoint is hit when the user submits the form.

â­ Responsibilities:
âœ” CORS headers for Shopify embedding
âœ” Parse multipart form using formidable
âœ” Accepts image uploads (palm)
âœ” Allows zero-byte files (important fix)
âœ” Verifies reCAPTCHA
âœ” Reads question + personal fields
âœ” Reads checkbox isPersonal to override classification
âœ” Classifies question with OpenAI (but not used for branching)
âœ” Runs local Pythagorean Numerology calculations
âœ” Calls OpenAI insights generator (astrology, numerology, palmistry or technical)
âœ” Builds a PDF using PDFKit
âœ” Sends email via Resend
âœ” Returns JSON for on-page summary
âœ” Short answer is returned in response.answer

Frontend displays it in the summary box.

âœ” For personal questions
PDF is always generated + emailed automatically.

âœ” For technical questions
PDF is only generated and emailed when user clicks Get Detailed Report â†’ /api/detailed-report.

Question Classification (classify-question.js)
âœ” Uses OpenAI GPT-4o to classify as:
personal
technical

âœ” Uses fallback keyword classifier if OpenAI fails
âœ” Classification metadata is fed into the prompt for OpenAI

(Helps model generate better content but does NOT determine branching.)

Insights Generation (generate-insights.js)
This is a critical file.
Depending on the mode:

A) Personal Question â†’ personalSummaries()
Generates:
Short direct answer
Astrology summary
Numerology summary
Palmistry summary

All in relation to:
The question
Birth data
NumerologyPack

The summaries feed into PDF sections:
Astrological Summary
Numerological Summary
Palm Reading Summary
(from the PDF template)

Technical Question â†’ technicalSummary()

Generates:
Short answer
Key points
Deeper explanation
Optional cautions or assumptions

Short answer returned to frontend
Full explanation stored in numerologyPack.technicalNotes (used as container for non-personal data).

PDF Generation (generate-pdf.js)
âœ” Uses PDFKit
âœ” Produces a clean, spaced, readable layout
âœ” Header "Melodies Web"
âœ” Title "Your Answer"
âœ” Uses the PDF structure from your template (tables and summaries)

âœ” Personal PDF includes:

Personal data table
Astrology Summary
Astrology table
Numerology Summary
Numerology table (with numbers injected)
Palmistry Summary
Palmistry table

âœ” Technical PDF includes:

Question
Short summary
Key points
Explanation 

mail Sending (send-email.js)
âœ” Uses Resend API
âœ” Verified sender: sales@hazcam.io
âœ” Supports binary PDF attachments
âœ” Robust error logging

Detailed Technical PDF Endpoint (/api/detailed-report.js)
âœ” Triggered only when user clicks Get Detailed Report for technical questions
âœ” Accepts question + email
âœ” Generates technical PDF
âœ” Emails it
âœ” Returns JSON to modal

Palmistry Image Upload Handling
âœ” formidable accepts palmImage
âœ” Backend captures filepath
(Palm analysis is not yet implemented in OpenAIâ€”currently optional but included in summaries.)

AI Censorship Detection (Frontend)

If OpenAI refuses (policy, safety, restricted topics), frontend rewrites:
"Censored by OpenAI â€” this question cannot be answered."

Common Failure Causes (pre-fixed)
ğŸŸ¥ 403 Errors

Usually:
Wrong environment variable name
Missing RECAPTCHA_SECRET
Missing RESEND_API_KEY

ğŸŸ¥ 404 Errors

Example:
/api/spiritual-report not found
â†’ Usually Shopify referencing path incorrectly or Vercel build missing a file.

ğŸŸ¥ reCAPTCHA not showing

Caused by:
Wrong sitekey
Double render
Shopify JS sandbox
Not using explicit mode (now fixed)


ğŸŸ¥ â€œAlready emailedâ€ issue

Technical questions were being treated as personal â†’ fixed via:
Checkbox override
Separate /api/detailed-report
Short Answer Generation Logic

âœ” Short answer is SEMANTIC not mystical
âœ” Generated by OpenAI using structured prompts
âœ” Uses classification hints
âœ” Personal questions also blend astro + numerology + palmistry into one synthesised answer

PDF Template Logic (from provided docs)
Personal PDF sections:

Your Name, Birth Info, Question
Your Answer
Astrological Summary (paragraph)
Astrology Table
Numerology Summary
Numerology Table
Palmistry Summary
Palmistry Table

Technical PDF:

Short, clean, one-page style:
Problem summary
Key points
Explanation

Astrology Detail
  Sun/Moon/Rising
  All planets
  All houses
  All aspects
  Degree + minute
  True astronomical precision
  Mercury â†’ Pluto
  North Node
  House cusps (1â€“12)
  Aspects (major + minor)
  Retrograde flags
  Exact degrees/minutes
  Tropical zodiac

  magazine-style explanations:
    Your core personality
    Emotional needs
    Communication style
    Life purpose
    Inner conflicts
    Strengths
    Soul themes
    Lessons
    Love profile
    Work style
    Compatibility insights
    Placidus system (default)


Numerology Detail
  Life Path
  Expression / Destiny
  Soul Urge
  Personality
  Maturity
  Karmic Lessons
  Karmic Debts
  Hidden Passion
  Pinnacles
  Challenges
  Personal Year
  Personal Month
  Personal Day

Palmestry Detail
  Life line
  Head line
  Heart line
  Fate line
  Sun line
  Girdle of Venus
  Simian crease
  Intuition lines
  Marriage lines
  Travel lines
  Markings: islands, chains, crosses, stars



