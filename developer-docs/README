/
/
├── api/
│   ├── spiritual-report.js        # Main endpoint
│   ├── detailed-report.js         # PDF-only technical endpoint
│
├── lib/
│   ├── ai.js                      # OpenAI wrappers + JSON-safe completions
│   ├── engines.js                 # Triad Engines (Palm/Astro/Numerology)
│   ├── insights.js                # Fusion + summary engine
│   ├── pdf.js                     # Premium PDF generator (Apple style)
│   ├── utils.js                   # reCAPTCHA, CORS, validation, email
│   └── fonts/
│       └── Inter-Regular.ttf      # PDF font
│
├── public/
│
└── README.md / DEVELOPER_DOCUMENTATION.md



| Key              | Purpose                                                        |
| ---------------- | -------------------------------------------------------------- |
| `OPENAI_API_KEY` | Authenticates OpenAI client for triad + classification engines |
| ---------------- | ---------------------------------------- |
| `RESEND_API_KEY` | API key for sending emails + attachments |
| `SUPPORT_EMAIL`  | “From” email address shown in user inbox |
| ---------------------- | ---------------------------------------- |
| `RECAPTCHA_SECRET_KEY` | Backend validation of v2 Checkbox tokens |
| ------------ | ------------------------------------------------------------ |
| `APP_DOMAIN` | Used for links inside emails + future user dashboard routing |

Test Keys:
| --------------------- | ------------ | -------------------------------------- |
| `TEST_MODE`           | `true/false` | Global toggle for free simulation mode |
| `TEST_MODE_OPENAI`    | `true/false` | Simulated AI responses                 |
| `TEST_MODE_EMAIL`     | `true/false` | Skip sending emails, log instead       |
| `TEST_MODE_PDF`       | `true/false` | Generate dummy 1-page PDF              |
| `TEST_MODE_RECAPTCHA` | `true/false` | Auto-pass CAPTCHA                      |


3. System Functional Overview
✔ Two main user paths:

Personal Question

Requires DOB, name, optional palm image

Triad Engines run

PDF is auto-generated

Email is auto-sent

Technical Question

Only question + optional file upload

Returns short answer to screen

PDF generated only when user clicks “Get Detailed Report”

✔ Triad Engines

The intelligence of the system comes from 3 AI-powered engines:

A) Palmistry Engine

Life line

Head line

Heart line

Fate + Sun lines

Intuition markers

Marriage lines

Special markings (stars, crosses, islands)

B) Astrology Engine

Sun / Moon / Rising

Planet placements

Houses

Aspects

Strengths + challenges

Life themes

Career + relationship signatures

C) Numerology Engine

Life Path

Expression

Soul Urge

Personality

Karmic lessons / debts

Pinnacles + challenges

✔ Insights Fusion Engine

All 3 readings are combined with:

The user’s question

The classification (personal / technical)

Weighted semantic cues

This generates:

Short answer (displayed on screen)

Deep multi-page PDF report

Summary reasoning section

✔ PDF System (Premium Apple-Style)

PDF includes:

Cover page (title, date)

Summary answer page

Triad sections:

Palmistry (full detail)

Astrology (full detail)

Numerology (full detail)

Final reasoning page (“How this answer was derived”)

PDF is generated via PDFKit using Inter-Regular.ttf for modern styling.

✔ Email System

Uses Resend

Sends branded HTML template

Attaches generated PDF

Sends from SUPPORT_EMAIL

Data Flow:
[Shopify Frontend]
    ↓
User fills form + reCAPTCHA
    ↓
FormData POST → /api/spiritual-report
    ↓
Backend:
  - Parse form (formidable)
  - Validate reCAPTCHA
  - Classify question
  - Run triad engines
  - Generate short answer
  - Build PDF (personal only)
  - Send email via Resend
    ↓
Return JSON → Shopify
    ↓
Frontend displays summary
    ↓
(User may request detailed PDF)
    ↓
/api/detailed-report
    ↓
Generate PDF
Send email

Technical Implementation Breakdown
/api/spiritual-report.js

Handles main question submission

Parses files & fields

Runs reCAPTCHA

Runs triad engines via generateInsights()

Generates personal PDFs

Sends emails using sendEmailHTML()

Returns JSON for frontend summary

/api/detailed-report.js

Only for technical follow-up PDFs

Accepts email + question

Generates technical PDF

Emails it

/lib/ai.js

OpenAI wrapper

JSON-safe completion mode

Fallback for classification

/lib/engines.js

Contains the 3 engines:

analyzePalm()

analyzeAstrology()

analyzeNumerology()

Each produces structured JSON.

/lib/insights.js

Combines Triad Engine results

Generates short on-screen answer

“Adaptive fusion” mode for reasoning

/lib/pdf.js

Apple-style PDF layout

Cover page

Multi-section content

Uses Inter font

/lib/utils.js

reCAPTCHA validator

CORS for Shopify storefront

File validation

Resend email wrapper

Maintenance Guide
To modify the PDF layout

Edit:
/lib/pdf.js
/lib/fonts/Inter-Regular.ttf

To update AI logic

Modify:
/lib/engines.js
/lib/insights.js

To add new personal attributes

Modify:

Frontend form

/api/spiritual-report.js

Insights engine

To change email layout

Modify HTML in:
/lib/emailTemplates/report.html

To add caching, rate limits, or abuse protection

Add wrappers in /lib/utils.js or new middleware in /api/.



