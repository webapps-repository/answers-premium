{% layout none %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Your Answer</title>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #fff; }
    #wrapper { max-width: 520px; margin: 0 auto; padding: 20px; }

    h2 { text-align: center; margin-bottom: 16px; }

    .field { margin-bottom: 12px; }
    .field label { font-weight: 600; display:block; margin-bottom:6px; }
    .field input, .field textarea {
      width:100%; padding:10px; border-radius:6px; border:1px solid #bbb; font-size:1rem;
    }

    #personal-fields { display:block; } /* always visible now */
    #compat-fields { display:none; margin-top:20px; }

    .btn {
      width:100%; padding:14px;
      border-radius:8px; border:none;
      font-weight:600; cursor:pointer; font-size:1rem;
      margin-top:10px;
    }

    #get-btn { background:#6c63ff; color:white; }

    .summary-box {
      background:#f7f5ff; padding:14px;
      border-radius:8px; margin-top:14px;
      line-height:1.55;
    }

    #status-text { margin-top:8px; font-size:0.9rem; color:#555; min-height:1em; }

    /* Apple/Stripe Spinner */
    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      margin: 20px auto 10px auto;
      border: 4px solid #dad9ff;
      border-top: 4px solid #6c63ff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin { 
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .compat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
      padding: 10px 0;
    }

    .compat-header {
      background: #f0f0ff;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      margin-top: 20px;
    }
  </style>
</head>

<body>

<div id="wrapper">

  <h2>Ask Melodie</h2>

  <form id="main-form" enctype="multipart/form-data">

    <!-- Removed personal checkbox -->

    <!-- Compatibility Checkbox -->
    <div class="field" style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" id="isCompat" style="width:20px;height:20px;">
      <label for="isCompat" style="margin:0;">Compatibility Reading</label>
    </div>

    <div class="field">
      <label>Email (required)</label>
      <input id="email" type="email" required>
    </div>

    <div class="field">
      <label>Your Question</label>
      <textarea id="question" name="question" maxlength="200"></textarea>
    </div>

    <!-- technical upload (deprecated but kept per your rules) -->
    <div class="field" id="technical-field">
      <label>Optional file upload</label>
      <input id="technicalFile" name="technicalFile" type="file">
    </div>

    <!-- PERSONAL MODE ALWAYS ACTIVE -->
    <div id="personal-fields">
      <div class="field"><label>Full Name</label><input id="fullName"></div>
      <div class="field"><label>Date of Birth</label><input id="birthDate" type="date"></div>
      <div class="field"><label>Time of Birth</label><input id="birthTime" type="time"></div>
      <div class="field"><label>Birth City</label><input id="birthCity"></div>
      <div class="field"><label>Birth State</label><input id="birthState"></div>
      <div class="field"><label>Birth Country</label><input id="birthCountry"></div>

      <div class="field">
        <label>Palm Photo (optional)</label>
        <input type="file" name="palmImage" accept="image/*">
      </div>
    </div>

    <!-- COMPATIBILITY MODE FIELDS -->
    <div id="compat-fields">

      <div class="compat-header">Your Details</div>
      <div class="compat-grid">
        <div class="field"><label>Full Name</label><input id="c1_fullName"></div>
        <div class="field"><label>Date of Birth</label><input id="c1_birthDate" type="date"></div>
        <div class="field"><label>Time of Birth</label><input id="c1_birthTime" type="time"></div>
        <div class="field"><label>Birth City</label><input id="c1_birthCity"></div>
        <div class="field"><label>Birth State</label><input id="c1_birthState"></div>
        <div class="field"><label>Birth Country</label><input id="c1_birthCountry"></div>
        <div class="field"><label>Palm Photo</label><input id="c1_palm" type="file" accept="image/*"></div>
      </div>

      <div class="compat-header">Partner Details</div>
      <div class="compat-grid">
        <div class="field"><label>Full Name</label><input id="c2_fullName"></div>
        <div class="field"><label>Date of Birth</label><input id="c2_birthDate" type="date"></div>
        <div class="field"><label>Time of Birth</label><input id="c2_birthTime" type="time"></div>
        <div class="field"><label>Birth City</label><input id="c2_birthCity"></div>
        <div class="field"><label>Birth State</label><input id="c2_birthState"></div>
        <div class="field"><label>Birth Country</label><input id="c2_birthCountry"></div>
        <div class="field"><label>Palm Photo</label><input id="c2_palm" type="file" accept="image/*"></div>
      </div>

    </div>

    <div class="field">
      <div id="recaptcha-box" style="min-height: 40px;"></div>
    </div>

    <button id="get-btn" class="btn">Get Answer</button>

    <div id="spinner" class="spinner"></div>
    <div id="status-text"></div>

  </form>

  <div id="summary" style="display:none;">
    <h3>Melodie Says</h3>
    <div id="summary-text" class="summary-box"></div>
  </div>

</div>

<script src="https://www.google.com/recaptcha/api.js?render=6LfTYRcsAAAAADwIcyRkQ9mkyJXIYuaRavmT8D-f"></script>

<script>
/* API endpoints */
const API_SPIRITUAL = "https://answers-rust.vercel.app/api/spiritual-report";
const API_TECHNICAL = "https://answers-rust.vercel.app/api/technical-report";

let recaptchaToken = null;

/* recaptcha */
function getRecaptchaToken() {
  return grecaptcha.execute("6LfTYRcsAAAAADwIcyRkQ9mkyJXIYuaRavmT8D-f", { action: "submit" })
    .then(t => (recaptchaToken = t));
}

/* elements */
const isCompat = document.getElementById("isCompat");
const personalFields = document.getElementById("personal-fields");
const technicalField = document.getElementById("technical-field");
const compatFields = document.getElementById("compat-fields");

const emailEl = document.getElementById("email");
const questionEl = document.getElementById("question");

const summaryWrap = document.getElementById("summary");
const summaryText = document.getElementById("summary-text");
const spinner = document.getElementById("spinner");
const statusText = document.getElementById("status-text");

/* toggle compatibility */
isCompat.addEventListener("change", () => {
  if (isCompat.checked) {
    personalFields.style.display = "none";
    technicalField.style.display = "none";
    compatFields.style.display = "block";
  } else {
    personalFields.style.display = "block";
    technicalField.style.display = "block";
    compatFields.style.display = "none";
  }
});

/* submit */
document.getElementById("main-form").addEventListener("submit", async e => {
  e.preventDefault();

  if (!emailEl.value) return alert("Email required.");
  if (!questionEl.value.trim()) return alert("Please enter a question.");

  spinner.style.display = "block";
  statusText.textContent = "Processingâ€¦";

  const token = await getRecaptchaToken();
  sendForm(token);
});

async function sendForm(token) {
  const fd = new FormData();

  fd.append("email", emailEl.value);
  fd.append("question", questionEl.value);
  fd.append("recaptchaToken", token);

  let endpoint = API_SPIRITUAL;

  if (isCompat.checked) {
    fd.append("mode", "compat");

    fd.append("c1_fullName", document.getElementById("c1_fullName").value);
    fd.append("c1_birthDate", document.getElementById("c1_birthDate").value);
    fd.append("c1_birthTime", document.getElementById("c1_birthTime").value);
    fd.append("c1_birthPlace", [
      document.getElementById("c1_birthCity").value,
      document.getElementById("c1_birthState").value,
      document.getElementById("c1_birthCountry").value
    ].join(", "));

    const c1Palm = document.getElementById("c1_palm").files[0];
    if (c1Palm) fd.append("c1_palm", c1Palm);

    fd.append("c2_fullName", document.getElementById("c2_fullName").value);
    fd.append("c2_birthDate", document.getElementById("c2_birthDate").value);
    fd.append("c2_birthTime", document.getElementById("c2_birthTime").value);
    fd.append("c2_birthPlace", [
      document.getElementById("c2_birthCity").value,
      document.getElementById("c2_birthState").value,
      document.getElementById("c2_birthCountry").value
    ].join(", "));

    const c2Palm = document.getElementById("c2_palm").files[0];
    if (c2Palm) fd.append("c2_palm", c2Palm);
  }

  else {
    /* regular personal mode */
    fd.append("fullName", document.getElementById("fullName").value);
    fd.append("birthDate", document.getElementById("birthDate").value);
    fd.append("birthTime", document.getElementById("birthTime").value);
    fd.append("birthPlace", [
      document.getElementById("birthCity").value,
      document.getElementById("birthState").value,
      document.getElementById("birthCountry").value
    ].join(", "));

    const palm = document.querySelector('input[name="palmImage"]').files[0];
    if (palm) fd.append("palmImage", palm);

    const tech = document.getElementById("technicalFile").files[0];
    if (tech) fd.append("technicalFile", tech);
  }

  let out;
  try {
    const r = await fetch(endpoint, { method: "POST", body: fd });
    out = await r.json();
  } catch (err) {
    spinner.style.display = "none";
    alert("Server error.");
    return;
  }

  spinner.style.display = "none";

  summaryText.innerHTML = out.shortAnswer || "(No answer)";
  summaryWrap.style.display = "block";

  statusText.textContent = "Your full report has been emailed.";
  alert("Your full report has been emailed!");
}
</script>

</body>
</html>
