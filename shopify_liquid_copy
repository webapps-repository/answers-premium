<style>
/* ====== FORM WRAPPER ====== */
.spiritual-container {
  max-width: 640px;
  margin: 30px auto;
  background: #ffffff;
  padding: 20px 22px;
  border-radius: 14px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.12);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Title */
.spiritual-container h2 {
  text-align: center;
  font-size: 1.6rem;
  margin-bottom: 14px;
  color: #4B0082;
}

/* Center content */
.spiritual-form {
  width: 100%;
}

/* Field labels */
.spiritual-form label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
  color: #333;
}

/* Inputs */
.spiritual-form input,
.spiritual-form textarea,
.spiritual-form select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
  margin-bottom: 14px;
  box-sizing: border-box;
}

/* Textarea */
#question {
  min-height: 90px;
  resize: vertical;
}

/* Checkbox personal section */
.personal-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
  cursor: pointer;
}

.personal-toggle input {
  width: 20px;
  height: 20px;
}

/* Personal section (slide down) */
#personal-fields {
  display: none;
  overflow: hidden;
  transition: max-height 0.35s ease;
  max-height: 0;
}

/* Button */
.btn-primary {
  background: #6c63ff;
  color: #fff;
  padding: 12px 18px;
  border-radius: 10px;
  border: none;
  font-size: 1.05rem;
  cursor: pointer;
  width: 100%;
  margin-top: 10px;
  font-weight: 600;
}

/* Progress Bar */
.progress-wrapper {
  margin-top: 15px;
}
.progress-bar {
  width: 100%;
  height: 8px;
  background: #eee;
  border-radius: 8px;
  overflow: hidden;
}
.progress-bar-inner {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #6c63ff, #8c7cff);
  transition: width 0.3s linear;
}

/* Spinner */
.spinner {
  display: none;
  text-align: center;
  margin-top: 8px;
  color: #6c63ff;
}

/* Summary Output */
#summary-container {
  display: none;
  margin-top: 20px;
}
.summary-box {
  background: #f3f1ff;
  padding: 14px;
  border-radius: 10px;
}

/* Detailed Report CTA */
#detailed-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  background: #4caf50;
  color: #fff;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

/* ===== MODAL ===== */
#email-modal-backdrop {
  position: fixed;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999999;
}

#email-modal {
  background: white;
  padding: 28px;
  width: 95%;
  max-width: 420px;
  border-radius: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  text-align: center;
}

#email-modal h3 {
  font-size: 1.35rem;
  margin-bottom: 18px;
  color: #222;
}

.modal-btn {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  font-size: 1rem;
  border: none;
  cursor: pointer;
}

.modal-send {
  background: #4caf50;
  color: white;
  font-weight: 600;
}

.modal-cancel {
  background: #ccc;
  color: black;
}

/* Mobile Tweaks */
@media (max-width: 600px) {
  .spiritual-container {
    margin: 10px;
    padding: 18px;
  }
}
</style>


<!-- ======================= HTML ======================= -->

<div class="spiritual-container">
  <h2>Your Question</h2>

  <form id="spiritual-form" class="spiritual-form" enctype="multipart/form-data">

    <!-- PERSONAL QUESTION TOGGLE -->
    <label class="personal-toggle">
      <input type="checkbox" id="isPersonal" name="isPersonal" />
      <span>Is this a personal question? (enter personal information)</span>
    </label>

    <!-- QUESTION FIELD -->
    <label>Your Question (max 25 words)</label>
    <textarea id="question" name="question" maxlength="200"
              placeholder="Example: Should I change jobs next year?"></textarea>

    <!-- PERSONAL FIELDS -->
    <div id="personal-fields">
      <label>Email</label>
      <input type="email" id="email" name="email" />

      <label>Full Name</label>
      <input type="text" id="name" name="name" />

      <label>Date of Birth (DD-MM-YYYY)</label>
      <input type="text" id="birthdate" name="birthdate" placeholder="13-03-1995" />

      <label>Time of Birth (HH:MM)</label>
      <input type="text" id="birthtime" name="birthtime" placeholder="09:00" />

      <label>City of Birth</label>
      <input type="text" id="birthcity" name="birthcity" />

      <label>State / Region</label>
      <input type="text" id="birthstate" name="birthstate" />

      <label>Country of Birth</label>
      <input type="text" id="birthcountry" name="birthcountry" />

      <label>Upload Right Palm (optional)</label>
      <input type="file" id="palmImage" name="palmImage" accept="image/*" />
    </div>

    <!-- RECAPTCHA -->
    <div id="recaptcha-box" style="margin: 12px 0;"></div>

    <button type="submit" class="btn-primary">Get Answer</button>

    <div class="progress-wrapper">
      <div class="progress-bar"><div class="progress-bar-inner" id="progress-inner"></div></div>
      <div class="spinner" id="spinner">Processing… please wait ⏳</div>
    </div>
  </form>

  <div id="summary-container">
    <h3>Short Answer</h3>
    <div class="summary-box" id="answer-summary">—</div>

    <button id="detailed-btn">Get Detailed Report (Free)</button>
  </div>
</div>


<!-- ===== MODAL HTML ===== -->
<div id="email-modal-backdrop">
  <div id="email-modal">
    <h3>Enter your email to receive the full PDF</h3>

    <input type="email" id="modal-email" placeholder="you@example.com"
           style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;" />

    <button id="modal-send" class="modal-btn modal-send">Send Report</button>
    <button id="modal-cancel" class="modal-btn modal-cancel">Cancel</button>
  </div>
</div>


<!-- RECAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js?onload=onLoadRecaptcha&render=explicit" async defer></script>


<script>
/* ============================================================
   CONFIG
============================================================ */
const API_SUMMARY = "https://answers-rust.vercel.app/api/spiritual-report";
const API_PDF = "https://answers-rust.vercel.app/api/detailed-report";

let recaptchaWidgetId = null;
let recaptchaReady = false;


/* ============================================================
   RECAPTCHA
============================================================ */
function onLoadRecaptcha() {
  const box = document.getElementById("recaptcha-box");
  if (!box) return;

  if (recaptchaWidgetId !== null) return;

  recaptchaWidgetId = grecaptcha.render("recaptcha-box", {
    sitekey: "6LdAOgYsAAAAAFgNlxLkahtIAbZc4XcIJt2hfLsj",
    theme: "light",
    size: "normal",
    callback: (t) => console.log("reCAPTCHA token:", t),
  });

  recaptchaReady = true;
}


/* ============================================================
   DOM ELEMENTS
============================================================ */
const form = document.getElementById("spiritual-form");
const personalCheckbox = document.getElementById("isPersonal");
const personalFields = document.getElementById("personal-fields");

const spinner = document.getElementById("spinner");
const progressInner = document.getElementById("progress-inner");
const summaryContainer = document.getElementById("summary-container");
const answerSummary = document.getElementById("answer-summary");

const detailedBtn = document.getElementById("detailed-btn");

const modalBackdrop = document.getElementById("email-modal-backdrop");
const modalEmail = document.getElementById("modal-email");
const modalSend = document.getElementById("modal-send");
const modalCancel = document.getElementById("modal-cancel");


/* ============================================================
   SLIDE DOWN PERSONAL FIELDS
============================================================ */
personalCheckbox.addEventListener("change", () => {
  if (personalCheckbox.checked) {
    personalFields.style.display = "block";
    personalFields.style.maxHeight = personalFields.scrollHeight + "px";
  } else {
    personalFields.style.maxHeight = "0px";
    setTimeout(() => { personalFields.style.display = "none"; }, 300);
  }
});


/* ============================================================
   PROGRESS BAR
============================================================ */
function animateProgress() {
  progressInner.style.width = "0%";
  setTimeout(() => { progressInner.style.width = "30%"; }, 100);
  setTimeout(() => { progressInner.style.width = "60%"; }, 600);
  setTimeout(() => { progressInner.style.width = "85%"; }, 1200);
}

function finishProgress() {
  progressInner.style.width = "100%";
  setTimeout(() => { progressInner.style.width = "0%"; }, 1500);
}


/* ============================================================
   SUBMIT — SHORT ANSWER
============================================================ */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!recaptchaReady) {
    alert("reCAPTCHA still loading…");
    return;
  }

  const token = grecaptcha.getResponse(recaptchaWidgetId);
  if (!token) {
    alert("Please complete the reCAPTCHA.");
    return;
  }

  spinner.style.display = "block";
  animateProgress();

  const formData = new FormData(form);
  formData.append("g-recaptcha-response", token);

  let result;

  try {
    const raw = await fetch(API_SUMMARY, { method: "POST", body: formData });
    const text = await raw.text();

    try {
      result = JSON.parse(text);
    } catch (err) {
      console.error("JSON error:", text);
      throw new Error("Invalid server response");
    }
  } catch (err) {
    spinner.style.display = "none";
    finishProgress();
    alert("Server error: " + err.message);
    return;
  }

  spinner.style.display = "none";
  finishProgress();

  // CENSOR DETECTION
  let shortAnswer = result.answer || "No answer received.";
  const lc = shortAnswer.toLowerCase();
  if (lc.includes("policy") || lc.includes("not permitted") || lc.includes("cannot assist")) {
    shortAnswer = "⚠️ Censored by OpenAI — this question cannot be answered.";
  }

  answerSummary.textContent = shortAnswer;
  summaryContainer.style.display = "block";

  grecaptcha.reset(recaptchaWidgetId);
});


/* ============================================================
   PDF BUTTON — show modal if needed
============================================================ */
detailedBtn.addEventListener("click", () => {
  const isPersonal = personalCheckbox.checked;
  const emailField = document.getElementById("email").value.trim();

  // PERSONAL → email already provided
  if (isPersonal && emailField) {
    sendReport(emailField);
    return;
  }

  // TECHNICAL → must ask for email
  modalBackdrop.style.display = "flex";
});


modalCancel.addEventListener("click", () => {
  modalBackdrop.style.display = "none";
});


modalSend.addEventListener("click", () => {
  const entered = modalEmail.value.trim();
  if (!entered) {
    alert("Please enter an email address");
    return;
  }

  modalBackdrop.style.display = "none";
  sendReport(entered);
});


/* ============================================================
   SEND REPORT → /api/detailed-report
============================================================ */
async function sendReport(email) {
  const question = document.getElementById("question").value.trim();
  const isPersonal = personalCheckbox.checked;

  const formData = new FormData();
  formData.append("email", email);
  formData.append("question", question);
  formData.append("isPersonal", isPersonal);

  if (isPersonal) {
    formData.append("name", document.getElementById("name").value);
    formData.append("birthdate", document.getElementById("birthdate").value);
    formData.append("birthtime", document.getElementById("birthtime").value);
    formData.append("birthcity", document.getElementById("birthcity").value);
    formData.append("birthstate", document.getElementById("birthstate").value);
    formData.append("birthcountry", document.getElementById("birthcountry").value);
  }

  try {
    const raw = await fetch(API_PDF, {
      method: "POST",
      body: formData,
    });

    const text = await raw.text();

    let json;
    try {
      json = JSON.parse(text);
    } catch {
      console.error("Non-JSON:", text);
      throw new Error("Invalid server response");
    }

    if (!json.success) {
      alert("Email error: " + (json.error || "unknown error"));
      return;
    }

    alert("Your detailed report has been emailed!");

  } catch (err) {
    alert("Failed to send report: " + err.message);
  }
}
</script>
