{% layout none %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Your Answer</title>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #fff; }
    #wrapper { max-width: 520px; margin: 0 auto; padding: 20px; }

    h2 { text-align: center; margin-bottom: 16px; }

    .field { margin-bottom: 12px; }
    .field label { font-weight: 600; display:block; margin-bottom:6px; }
    .field input, .field textarea {
      width:100%; padding:10px; border-radius:6px; border:1px solid #bbb; font-size:1rem;
    }

    #personal-fields { display:none; }

    .btn {
      width:100%; padding:14px;
      border-radius:8px; border:none;
      font-weight:600; cursor:pointer; font-size:1rem;
      margin-top:10px;
    }

    #get-btn { background:#6c63ff; color:white; }

    .summary-box {
      background:#f7f5ff; padding:14px;
      border-radius:8px; margin-top:14px;
      line-height:1.55;
    }

    .spinner { display:none; text-align:center; margin-top:10px; color:#444; }

    #status-text { margin-top:8px; font-size:0.9rem; color:#555; min-height:1em; }

    #progress { width:100%; height:8px; background:#eee; border-radius:6px; overflow:hidden; margin-top:10px; }
    #progress-inner { width:0%; height:100%; background:#6c63ff; transition:width .3s linear;}
  </style>
</head>

<body>

<div id="wrapper">

  <h2>Your Answer (AI Insight Report)</h2>

  <form id="main-form" enctype="multipart/form-data">

    <div class="field" style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" id="isPersonal" style="width:20px;height:20px;">
      <label for="isPersonal" style="margin:0;">This is a personal question</label>
    </div>

    <div class="field">
      <label>Email (required)</label>
      <input id="email" type="email" required>
    </div>

    <div class="field">
      <label>Your Question</label>
      <textarea id="question" name="question" maxlength="200"></textarea>
    </div>

    <!-- technical upload -->
    <div class="field" id="technical-field">
      <label>Optional file upload</label>
      <input id="technicalFile" name="technicalFile" type="file">
    </div>

    <!-- personal mode -->
    <div id="personal-fields">

      <div class="field"><label>Full Name</label><input id="fullName"></div>
      <div class="field"><label>Date of Birth</label><input id="birthDate" type="date"></div>
      <div class="field"><label>Time of Birth</label><input id="birthTime" type="time"></div>
      <div class="field"><label>Birth City</label><input id="birthCity"></div>
      <div class="field"><label>Birth State</label><input id="birthState"></div>
      <div class="field"><label>Birth Country</label><input id="birthCountry"></div>

      <div class="field">
        <label>Palm Photo (optional)</label>
        <input type="file" name="palmImage" accept="image/*">
      </div>
    </div>

    <div class="field">
      <div id="recaptcha-box" style="min-height: 40px;"></div>
    </div>

    <button id="get-btn" class="btn">Get Answer</button>

    <div id="progress"><div id="progress-inner"></div></div>
    <div id="spinner" class="spinner">Processing…</div>
    <div id="status-text"></div>

  </form>

  <div id="summary" style="display:none;">
    <h3>Short Answer</h3>
    <div id="summary-text" class="summary-box"></div>
  </div>

</div>

<script src="https://www.google.com/recaptcha/api.js?render=6LfTYRcsAAAAADwIcyRkQ9mkyJXIYuaRavmT8D-f"></script>

<script>
/* ================================
   API ENDPOINTS
================================ */
const API_SPIRITUAL = "https://answers-rust.vercel.app/api/spiritual-report";
const API_TECHNICAL = "https://answers-rust.vercel.app/api/technical-report";

let recaptchaToken = null;

/* ======================================================
   INVISIBLE v2 — AUTO MODE (NO MANUAL RENDER REQUIRED)
====================================================== */
function getRecaptchaToken() {
  return grecaptcha.execute("6LfTYRcsAAAAADwIcyRkQ9mkyJXIYuaRavmT8D-f", { action: "submit" })
    .then(token => {
      console.log("INVISIBLE TOKEN:", token);
      recaptchaToken = token;
      return token;
    });
}

/* =================================
   ELEMENTS
================================= */
const isPersonalBox = document.getElementById("isPersonal");
const personalFields = document.getElementById("personal-fields");
const technicalField = document.getElementById("technical-field");

const questionEl = document.getElementById("question");
const emailEl = document.getElementById("email");
const technicalFile = document.getElementById("technicalFile");

const progressInner = document.getElementById("progress-inner");
const spinner = document.getElementById("spinner");
const statusText = document.getElementById("status-text");
const summaryWrap = document.getElementById("summary");
const summaryText = document.getElementById("summary-text");

/* =================================
   MODE TOGGLE
================================= */
isPersonalBox.addEventListener("change", () => {
  personalFields.style.display = isPersonalBox.checked ? "block" : "none";
  technicalField.style.display = isPersonalBox.checked ? "none" : "block";
  summaryWrap.style.display = "none";
  statusText.textContent = "";
});

/* =================================
   PROGRESS BAR
================================= */
function progressStart() {
  progressInner.style.transition = "width 1.2s linear";
  progressInner.style.width = "40%";
  setTimeout(() => (progressInner.style.width = "80%"), 1300);
}

function progressFinish() {
  progressInner.style.width = "100%";
  setTimeout(() => (progressInner.style.width = "0%"), 900);
}

/* =================================
   FORM SUBMIT
================================= */
document.getElementById("main-form").addEventListener("submit", async e => {
  e.preventDefault();

  if (!emailEl.value) return alert("Email required.");
  if (!questionEl.value.trim()) return alert("Please enter a question.");

  spinner.style.display = "block";
  statusText.textContent = "Processing…";
  progressStart();

  const token = await getRecaptchaToken();
  submitForm(token);
});

/* =================================
   SEND FORM TO BACKEND
================================= */
async function submitForm(token) {
  const fd = new FormData();
  fd.append("email", emailEl.value);
  fd.append("question", questionEl.value);
  fd.append("recaptchaToken", token);

  let endpoint = isPersonalBox.checked ? API_SPIRITUAL : API_TECHNICAL;

  if (isPersonalBox.checked) {
    fd.append("fullName", document.getElementById("fullName").value);
    fd.append("birthDate", document.getElementById("birthDate").value);
    fd.append("birthTime", document.getElementById("birthTime").value);

    fd.append(
      "birthPlace",
      [
        document.getElementById("birthCity").value,
        document.getElementById("birthState").value,
        document.getElementById("birthCountry").value
      ].join(", ")
    );

    const palm = document.querySelector('input[name="palmImage"]').files[0];
    if (palm) fd.append("palmImage", palm);

  } else {
    if (technicalFile.files[0]) fd.append("technicalFile", technicalFile.files[0]);
  }

  let out;
  try {
    const r = await fetch(endpoint, { method: "POST", body: fd });
    out = await r.json();
  } catch (err) {
    console.error(err);
    spinner.style.display = "none";
    alert("Server error.");
    return;
  }

  spinner.style.display = "none";
  progressFinish();

  summaryText.innerHTML = out.shortAnswer || "(No answer)";
  summaryWrap.style.display = "block";

  statusText.textContent = "Your full report has been emailed.";
  alert("Your full report has been emailed!");
}
</script>

</body>
</html>
