// /api/utils/generatePdf.js
import getStream from "get-stream";

// âœ… Dynamically import pdfkit (works on Vercel)
let PDFDocument;
try {
  PDFDocument = (await import("pdfkit")).default;
} catch (err) {
  console.error("âŒ Failed to load PDFKit:", err);
  throw err;
}

export async function generatePdfBuffer({
  fullName,
  birthdate,
  birthTime,
  birthPlace,
  question,
  answer,
  astrology,
  numerology,
  palmistry,
}) {
  const doc = new PDFDocument({ margin: 50 });
  const chunks = [];

  doc.on("data", (chunk) => chunks.push(chunk));
  doc.on("end", () => console.log("âœ… PDF generation complete"));

  // --- Header ---
  doc
    .fontSize(22)
    .fillColor("#4B0082")
    .text("ğŸŒŒ Personal Spiritual Report", { align: "center" })
    .moveDown(1.2);

  // --- User Info ---
  doc.fontSize(12).fillColor("#000");
  doc.text(`ğŸ§‘ Name: ${fullName}`);
  doc.text(`ğŸ“… Birth Date: ${birthdate}`);
  doc.text(`â° Birth Time: ${birthTime || "Unknown"}`);
  doc.text(`ğŸŒ Birth Place: ${birthPlace}`);
  doc.text(`ğŸ’­ Question: ${question || "â€”"}`).moveDown(1.2);

  // --- Answer Section ---
  doc
    .fontSize(16)
    .fillColor("#4B0082")
    .text("ğŸ”® Answer to Your Question", { underline: true })
    .moveDown(0.5);
  doc.fontSize(12).fillColor("#333").text(answer || "No answer available.").moveDown(1.5);

  // Helper to draw simple tables
  const drawTable = (rows) => {
    const startY = doc.y;
    const rowHeight = 22;
    const col1Width = 160;
    const col2Width = 360;
    const tableLeft = 50;

    rows.forEach((row, i) => {
      const y = startY + i * rowHeight;
      // alternate row shading
      if (i % 2 === 0) {
        doc.rect(tableLeft, y, col1Width + col2Width, rowHeight).fill("#f8f8ff");
      }
      doc
        .fillColor("#000")
        .fontSize(11)
        .text(row[0], tableLeft + 5, y + 5, { width: col1Width })
        .text(row[1], tableLeft + col1Width + 10, y + 5, { width: col2Width });
      doc.fillColor("#000");
    });

    doc.moveDown(rows.length * 0.25 + 1.5);
  };

  // --- ğŸª Astrology Table ---
  doc
    .fontSize(16)
    .fillColor("#4B0082")
    .text("â˜€ï¸ Astrology Insights", { underline: true })
    .moveDown(0.5);

  drawTable([
    ["ğŸŒ The Sun", "Core identity, vitality, and self-expression."],
    ["ğŸŒ™ The Moon", "Emotions, instincts, and inner world."],
    ["ğŸŒ… Rising Sign (Ascendant)", "How others perceive you; your approach to new situations."],
    ["ğŸª Ruling Planet", "Defines your overall life tone and approach."],
    ["ğŸ  Astrological Houses", "Show where life themes play out (career, home, relationships)."],
    ["â¤ï¸ Love House", "Indicates romantic energy and emotional connection patterns."],
    ["ğŸ’¼ Career & Business", "Ambition, reputation, and public image indicators."],
    ["ğŸ’« Health & Wellbeing", "Predicts vitality and personal balance across life cycles."],
  ]);

  doc
    .fontSize(11)
    .fillColor("#333")
    .text(astrology || "Astrology interpretation unavailable.")
    .moveDown(1.5);

  // --- ğŸ”¢ Numerology Table ---
  doc
    .fontSize(16)
    .fillColor("#4B0082")
    .text("ğŸ”¢ Numerology Insights", { underline: true })
    .moveDown(0.5);

  drawTable([
    ["1ï¸âƒ£ Life Path Number", "Your core life purpose and spiritual path."],
    ["2ï¸âƒ£ Expression Number", "Natural talents, potential, and outward capabilities."],
    ["3ï¸âƒ£ Personality Number", "How others perceive your personality and energy."],
    ["4ï¸âƒ£ Soul Urge Number", "Your innermost desires and emotional motivations."],
    ["5ï¸âƒ£ Maturity Number", "The wisdom and fulfillment gained later in life."],
  ]);

  doc
    .fontSize(11)
    .fillColor("#333")
    .text(numerology || "Numerology interpretation unavailable.")
    .moveDown(1.5);

  // --- âœ‹ Palmistry Table ---
  doc
    .fontSize(16)
    .fillColor("#4B0082")
    .text("âœ‹ Palmistry Insights", { underline: true })
    .moveDown(0.5);

  drawTable([
    ["ğŸ«€ Life Line", "Vitality & stamina â€” long/deep means robust health, short shows independence."],
    ["ğŸ§  Head Line", "Intellect & focus â€” deep = clarity, wavy = creativity, breaks = mental shifts."],
    ["ğŸ’ Heart Line", "Emotional & love life â€” deep = passion, breaks = emotional turning points."],
    ["ğŸ§­ Fate Line", "Career & destiny â€” clear = purpose, broken = major life changes."],
    ["ğŸ¤² Fingers", "Each finger highlights traits: thumb=willpower, index=ambition, ring=creativity."],
    ["ğŸŒ• Mounts", "Jupiter=leadership, Venus=love, Luna=intuition â€” reveal areas of strength."],
  ]);

  doc
    .fontSize(11)
    .fillColor("#333")
    .text(palmistry || "Palmistry interpretation unavailable.")
    .moveDown(1.8);

  // --- Footer ---
  doc
    .fontSize(10)
    .fillColor("#777")
    .text(
      "âœ¨ Generated by Hazcam Spiritual Systems â€” merging astrology, numerology & palmistry for insight âœ¨",
      { align: "center" }
    );

  doc.end();
  return await getStream.buffer(doc);
}
